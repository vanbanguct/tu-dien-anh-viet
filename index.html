<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T·ª´ ƒëi·ªÉn Anh - Vi·ªát (Autocomplete + Ghi ch√∫ t·ª´ m·ªõi)</title>
  <style>
    :root { --b:#e7e7e7; --bg:#fafafa; --txt:#111; --muted:#666; --danger:#b00020; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--txt); background:var(--bg); }
    .wrap{ width:min(1100px,92%); margin:24px auto; }
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px; background:#fff; border:1px solid var(--b); border-radius:14px;
    }
    .title{ font-weight:800; }
    .muted{ color:var(--muted); font-size:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, button, select, textarea{
      font:inherit; padding:10px 12px; border:1px solid var(--b); border-radius:10px; background:#fff;
    }
    textarea{ resize:vertical; min-height:92px; }
    button{ cursor:pointer; font-weight:700; }
    button.primary{ background:#111; color:#fff; border-color:#111; }
    button.danger{ background:var(--danger); color:#fff; border-color:var(--danger); }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    .card{
      margin-top:14px; background:#fff; border:1px solid var(--b); border-radius:14px; padding:14px;
    }
    .grid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; } }

    table{ width:100%; border-collapse:separate; border-spacing:0; }
    th,td{ text-align:left; padding:10px 10px; border-bottom:1px solid var(--b); vertical-align:top; }
    th{ font-size:13px; color:var(--muted); }
    .tag{
      display:inline-block; padding:4px 8px; border:1px solid var(--b); border-radius:999px;
      font-size:12px; margin:2px 6px 2px 0; background:#fff;
    }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{ padding:6px 10px; border:1px solid var(--b); border-radius:999px; font-size:13px; background:#fff; }
    .hidden{ display:none !important; }
    .hint{ font-size:13px; color:var(--muted); margin-top:8px; line-height:1.4; }
    .hr{ height:1px; background:var(--b); margin:12px 0; }
    .small{ font-size:12px; color:var(--muted); }
    .right{ margin-left:auto; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .toast{ margin-top:10px; font-size:13px; }

    mark { padding: 0 2px; border-radius: 4px; }

    /* Autocomplete */
    .searchWrap{ position:relative; flex:1; min-width:240px; }
    #q{ width:100%; }
    .ac{
      position:absolute; top:calc(100% + 6px); left:0; right:0;
      background:#fff; border:1px solid var(--b); border-radius:12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.08);
      max-height: 280px; overflow:auto;
      z-index: 50;
      padding:6px;
    }
    .acItem{
      display:flex; flex-direction:column; gap:2px;
      padding:10px 10px; border-radius:10px;
      cursor:pointer;
    }
    .acItem:hover, .acItem.active{ background:#f3f3f3; }
    .acTop{ display:flex; gap:10px; align-items:baseline; justify-content:space-between; }
    .acEn{ font-weight:800; }
    .acVi{ color:var(--muted); font-size:13px; }
    .acTags{ margin-top:2px; }
    .acEmpty{ padding:10px; color:var(--muted); font-size:13px; }
  
    /* Admin editor: make Add/Edit column wider & inputs taller */
    #adminPanel .grid{ grid-template-columns: 2fr 1fr 1fr; }
    #adminPanel input, #adminPanel textarea, #adminPanel select{
      padding: 14px 14px;
      font-size: 16px;
      border-radius: 12px;
    }
    #adminPanel .cardlikeBig{
      padding: 16px;
    }
    #adminPanel #vi{ min-height: 56px; }

  
    /* Nicer vertical form layout for Add/Edit */
    #adminPanel .adminEditor label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
      font-weight:700;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    #adminPanel .adminEditor input, #adminPanel .adminEditor textarea{
      width:100%;
    }
    #adminPanel .adminEditor textarea{
      min-height: 120px;
    }
    #adminPanel .adminEditor .row{
      margin-top:12px;
    }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">üìò T·ª´ ƒëi·ªÉn Anh ‚Üí Vi·ªát (Autocomplete + Ghi ch√∫ t·ª´ m·ªõi)</div>
        <div class="muted">Ai c√≥ link ƒë·ªÅu xem & tra c·ª©u. Ch·ªâ <b>Admin</b> m·ªõi Import/S·ª≠a/X√≥a.</div>
      </div>
      <div class="row">
        <span id="authState" class="pill">Ch∆∞a ƒëƒÉng nh·∫≠p</span>
        <button id="btnLoginOpen">ƒêƒÉng nh·∫≠p Admin</button>
        <button id="btnLogout" class="hidden">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <!-- Search -->
    <div class="card">
      <div class="row" style="align-items:center; width:100%;">
        <div class="searchWrap">
          <input id="q" autocomplete="off" placeholder="Nh·∫≠p t·ª´ c·∫ßn tra: v√≠ d·ª• 'app', 'h·∫πn', ho·∫∑c tag..." />
          <div id="ac" class="ac hidden" role="listbox" aria-label="G·ª£i √Ω t·ª´"></div>
        </div>

        <select id="tagFilter">
          <option value="">T·∫•t c·∫£ tag</option>
        </select>

        <button id="btnClear">X√≥a l·ªçc</button>

        <span class="right small">T·ªïng: <b id="countAll">0</b> | ƒêang hi·ªán: <b id="countShown">0</b></span>
      </div>

      <div class="hint">
        Autocomplete ∆∞u ti√™n theo <b>T·ª´ ti·∫øng Anh</b>. T√¨m trong b·∫£ng v·∫´n h·ªó tr·ª£ <b>ti·∫øng Vi·ªát</b> v√† <b>tag</b>.
        Tag nh·∫≠p d·∫°ng: <span class="mono">y t·∫ø, du l·ªãch, h·ªçc thu·∫≠t</span>
      </div>
    </div>

    <!-- New word request (public) -->
    <div class="card">
      <div class="row" style="align-items:center;">
        <div class="title" style="font-size:16px;">üìù Ghi ch√∫ / y√™u c·∫ßu gi·∫£i nghƒ©a t·ª´ m·ªõi</div>
        <span class="right small">D√†nh cho m·ªçi ng∆∞·ªùi</span>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
        <div>
          <label class="small" for="reqEn"><b>T·ª´ ti·∫øng Anh c·∫ßn gi·∫£i nghƒ©a</b></label>
          <input id="reqEn" placeholder="V√≠ d·ª•: resilience" />
          <div class="hint">B·∫°n c√≥ th·ªÉ nh·∫≠p c·ª•m t·ª´: <span class="mono">boarding pass</span></div>
        </div>
        <div>
          <label class="small" for="reqTags"><b>Tag c√¥ng d·ª•ng (n·∫øu bi·∫øt)</b></label>
          <input id="reqTags" placeholder="V√≠ d·ª•: y t·∫ø, c√¥ng vi·ªác" />
          <div class="hint">Kh√¥ng b·∫Øt bu·ªôc.</div>
        </div>
        <div style="grid-column: 1 / -1;">
          <label class="small" for="reqNote"><b>Gi·∫£i th√≠ch / ng·ªØ c·∫£nh / ghi ch√∫</b></label>
          <textarea id="reqNote" placeholder="V√≠ d·ª•: g·∫∑p trong email kh√°ch h√†ng, kh√¥ng ch·∫Øc nghƒ©a; c·∫ßn gi·∫£i nghƒ©a ph√π h·ª£p b·ªëi c·∫£nh..."></textarea>
          <div class="row">
            <button id="btnReqSubmit" class="primary">G·ª≠i ghi ch√∫</button>
            <button id="btnReqClear">X√≥a n·ªôi dung</button>
            <span id="reqStatus" class="small right"></span>
          </div>
          <div class="hint">
            ‚ö†Ô∏è N·∫øu b·∫°n ch·ªâ host d·∫°ng <b>file tƒ©nh</b>, ghi ch√∫ n√†y s·∫Ω l∆∞u v√†o tr√¨nh duy·ªát c·ªßa ng∆∞·ªùi g·ª≠i (localStorage). 
            Mu·ªën Admin nh·∫≠n ƒë∆∞·ª£c ghi ch√∫ t·ª´ m·ªçi ng∆∞·ªùi, c·∫ßn 1 n∆°i l∆∞u chung (Google Sheet/Form ho·∫∑c backend).
          </div>
        </div>
      </div>
    </div>

    <!-- Admin panel -->
    <div id="adminPanel" class="card hidden">
      <div class="row" style="align-items:center;">
        <div class="title" style="font-size:16px;">üîß Qu·∫£n tr·ªã (ch·ªâ Admin)</div>
        <button id="btnExport" class="right">Export JSON</button>
        <button id="btnReset" class="danger">Reset d·ªØ li·ªáu</button>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div class="adminEditor">
          <div class="muted" style="margin-bottom:8px;">Th√™m / S·ª≠a m·ª•c t·ª´</div>

          <label for="en">T·ª´ ti·∫øng Anh</label>
          <input id="en" placeholder="V√≠ d·ª•: run" />

          <label for="vi">Gi·∫£i nghƒ©a ti·∫øng Vi·ªát</label>
          <textarea id="vi" placeholder="Nh·∫≠p gi·∫£i nghƒ©a ti·∫øng Vi·ªát (c√≥ th·ªÉ xu·ªëng d√≤ng)"></textarea>

          <label for="tags">C√¥ng d·ª•ng (tag)</label>
          <input id="tags" placeholder="V√≠ d·ª•: y t·∫ø, vƒÉn ph√≤ng, du l·ªãch" />

          <div class="row">
            <button id="btnSave" class="primary">L∆∞u</button>
            <button id="btnCancelEdit">H·ªßy s·ª≠a</button>
            <span class="small" id="editState">ƒêang th√™m m·ªõi</span>
          </div>

          <div class="hint">Tag nh·∫≠p d·∫°ng: <span class="mono">tag1, tag2, tag3</span></div>
        </div>

        <div>
          <div class="muted" style="margin-bottom:8px;">Import d·ªØ li·ªáu</div>
          <input type="file" id="fileInput" accept=".json,.csv,text/csv,application/json" />
          <div class="hint">
            H·ªó tr·ª£:
            <ul style="margin:8px 0 0; padding-left:18px;">
              <li><b>JSON</b>: m·∫£ng c√°c object { en, vi, tags }</li>
              <li><b>CSV</b> header: <span class="mono">en,vi,tags</span></li>
            </ul>
          </div>
          <div class="row" style="margin-top:10px;">
            <button id="btnImport" class="primary">Import</button>
            <button id="btnDownloadTemplate">T·∫£i m·∫´u CSV</button>
          </div>
        </div>

        <div>
          <div class="muted" style="margin-bottom:8px;">Danh s√°ch ghi ch√∫ t·ª´ m·ªõi</div>
          <div class="hint" style="margin-top:0;">
            Admin c√≥ th·ªÉ xem/t·∫£i/export ghi ch√∫ (trong m√°y Admin). N·∫øu b·∫°n mu·ªën ‚Äúgom‚Äù ghi ch√∫ t·ª´ m·ªçi ng∆∞·ªùi v·ªÅ 1 ch·ªó, n√≥i m√¨nh ‚Äî m√¨nh s·∫Ω g·∫Øn Google Sheet/Form.
          </div>
          <div class="row">
            <button id="btnReqExport">Export ghi ch√∫ (JSON)</button>
            <button id="btnReqClearAll" class="danger">X√≥a to√†n b·ªô ghi ch√∫</button>
          </div>
        </div>
      </div>

      <div id="toast" class="toast muted"></div>

      <div class="hr"></div>

      <div class="muted" style="margin-bottom:8px;">B·∫£ng ghi ch√∫ (Admin)</div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:18%;">T·ª´</th>
              <th style="width:22%;">Tag</th>
              <th>Ghi ch√∫</th>
              <th style="width:160px;">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="reqTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Dictionary Table -->
    <div class="card">
      <table>
        <thead>
          <tr>
            <th style="width:22%;">T·ª´ ti·∫øng Anh</th>
            <th style="width:48%;">Gi·∫£i nghƒ©a ti·∫øng Vi·ªát</th>
            <th style="width:30%;">C√¥ng d·ª•ng (tag)</th>
            <th style="width:140px;">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="hint">
      D·ªØ li·ªáu t·ª´ ƒëi·ªÉn v√† ghi ch√∫ ƒëang l∆∞u trong <span class="mono">localStorage</span> c·ªßa tr√¨nh duy·ªát.
    </div>
  </div>

  <!-- Login modal -->
  <dialog id="loginDialog">
    <form method="dialog" style="min-width:min(420px, 92vw); padding:16px;">
      <div class="title" style="font-size:16px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ Import / S·ª≠a / X√≥a</div>
      <p class="muted" style="margin-top:6px;">Nh·∫≠p username/password b·∫°n ƒë√£ ch·ªâ ƒë·ªãnh trong file.</p>
      <div class="row" style="flex-direction:column; align-items:stretch;">
        <input id="loginUser" placeholder="Username" autocomplete="username" />
        <input id="loginPass" placeholder="Password" type="password" autocomplete="current-password" />
      </div>
      <div class="row" style="margin-top:12px; justify-content:flex-end;">
        <button value="cancel">H·ªßy</button>
        <button id="btnLogin" class="primary" value="ok">ƒêƒÉng nh·∫≠p</button>
      </div>
      <p id="loginMsg" class="small" style="color:var(--danger); margin:10px 0 0;"></p>
    </form>
  </dialog>

  <script>
    /***********************
     * CONFIG: ADMIN ACCOUNT
     ***********************/
    const ADMIN_USER = "admin";
    const ADMIN_PASS = "123456";

    /***********************
     * STORAGE KEYS
     ***********************/
    const LS_KEY_DATA = "av_dict_data_v3";
    const LS_KEY_AUTH = "av_dict_auth_v3";
    const LS_KEY_REQS = "av_dict_reqs_v1";

    /***********************
     * SEED DATA
     ***********************/
    const seedData = [
      { en: "run", vi: "ch·∫°y; v·∫≠n h√†nh", tags: ["th·ªÉ thao", "ƒë·ªông t·ª´ ph·ªï bi·∫øn"] },
      { en: "appointment", vi: "cu·ªôc h·∫πn", tags: ["y t·∫ø", "c√¥ng vi·ªác"] },
      { en: "boarding pass", vi: "th·∫ª l√™n m√°y bay", tags: ["du l·ªãch", "h√†ng kh√¥ng"] },
      { en: "apply", vi: "n·ªôp ƒë∆°n; √°p d·ª•ng", tags: ["c√¥ng vi·ªác", "h·ªçc thu·∫≠t"] },
      { en: "application", vi: "·ª©ng d·ª•ng; ƒë∆°n xin", tags: ["c√¥ng ngh·ªá", "h√†nh ch√≠nh"] },
    ];

    let data = loadData();
    let reqs = loadReqs();
    let isAuthed = loadAuth();
    let editingId = null;

    // Autocomplete state
    let acItems = [];
    let acActiveIndex = -1;

    // UI refs
    const tbody = document.getElementById("tbody");
    const q = document.getElementById("q");
    const ac = document.getElementById("ac");
    const tagFilter = document.getElementById("tagFilter");
    const countAll = document.getElementById("countAll");
    const countShown = document.getElementById("countShown");
    const adminPanel = document.getElementById("adminPanel");
    const authState = document.getElementById("authState");
    const btnLoginOpen = document.getElementById("btnLoginOpen");
    const btnLogout = document.getElementById("btnLogout");
    const btnClear = document.getElementById("btnClear");

    // Public request
    const reqEn = document.getElementById("reqEn");
    const reqTags = document.getElementById("reqTags");
    const reqNote = document.getElementById("reqNote");
    const btnReqSubmit = document.getElementById("btnReqSubmit");
    const btnReqClear = document.getElementById("btnReqClear");
    const reqStatus = document.getElementById("reqStatus");

    // Admin request table
    const reqTbody = document.getElementById("reqTbody");
    const btnReqExport = document.getElementById("btnReqExport");
    const btnReqClearAll = document.getElementById("btnReqClearAll");

    // Admin fields
    const en = document.getElementById("en");
    const vi = document.getElementById("vi");
    const tags = document.getElementById("tags");
    const btnSave = document.getElementById("btnSave");
    const btnCancelEdit = document.getElementById("btnCancelEdit");
    const editState = document.getElementById("editState");

    // Import/export
    const fileInput = document.getElementById("fileInput");
    const btnImport = document.getElementById("btnImport");
    const btnExport = document.getElementById("btnExport");
    const btnReset = document.getElementById("btnReset");
    const btnDownloadTemplate = document.getElementById("btnDownloadTemplate");

    // Login dialog
    const loginDialog = document.getElementById("loginDialog");
    const loginUser = document.getElementById("loginUser");
    const loginPass = document.getElementById("loginPass");
    const btnLogin = document.getElementById("btnLogin");
    const loginMsg = document.getElementById("loginMsg");

    const toast = document.getElementById("toast");

    init();

    function init(){
      refreshAuthUI();
      rebuildTagFilter();
      render();
      renderReqs();

      // Public request events
      btnReqSubmit.addEventListener("click", () => {
        const enVal = (reqEn.value || "").trim();
        const tagsVal = (reqTags.value || "").trim();
        const noteVal = (reqNote.value || "").trim();

        if(!enVal || !noteVal){
          reqStatus.style.color = "var(--danger)";
          reqStatus.textContent = "Vui l√≤ng nh·∫≠p: T·ª´ ti·∫øng Anh + Ghi ch√∫/ng·ªØ c·∫£nh.";
          return;
        }

        const item = {
          id: crypto.randomUUID(),
          en: enVal,
          tags: parseTags(tagsVal),
          note: noteVal,
          createdAt: new Date().toISOString()
        };
        reqs.unshift(item);
        saveReqs();
        renderReqs();

        reqStatus.style.color = "#0b6";
        reqStatus.textContent = "ƒê√£ ghi ch√∫ (l∆∞u trong tr√¨nh duy·ªát c·ªßa b·∫°n).";
        setTimeout(()=> reqStatus.textContent = "", 3500);
      });

      btnReqClear.addEventListener("click", () => {
        reqEn.value = "";
        reqTags.value = "";
        reqNote.value = "";
        reqStatus.textContent = "";
      });

      // Search + autocomplete
      q.addEventListener("input", () => { render(); buildAutocomplete(); });
      q.addEventListener("focus", () => { buildAutocomplete(); });

      q.addEventListener("keydown", (e) => {
        if(ac.classList.contains("hidden")) return;
        if(e.key === "ArrowDown"){
          e.preventDefault();
          acActiveIndex = Math.min(acActiveIndex + 1, acItems.length - 1);
          renderAutocomplete();
        }else if(e.key === "ArrowUp"){
          e.preventDefault();
          acActiveIndex = Math.max(acActiveIndex - 1, 0);
          renderAutocomplete();
        }else if(e.key === "Enter"){
          if(acActiveIndex >= 0 && acActiveIndex < acItems.length){
            e.preventDefault();
            selectAutocomplete(acItems[acActiveIndex]);
          }
        }else if(e.key === "Escape"){
          hideAutocomplete();
        }
      });

      document.addEventListener("click", (e) => {
        const wrap = q.closest(".searchWrap");
        if(!wrap.contains(e.target)) hideAutocomplete();
      });

      tagFilter.addEventListener("change", () => { render(); hideAutocomplete(); });

      btnClear.addEventListener("click", () => { q.value=""; tagFilter.value=""; render(); buildAutocomplete(true); });

      // Auth
      btnLoginOpen.addEventListener("click", () => {
        loginMsg.textContent = "";
        loginUser.value = "";
        loginPass.value = "";
        loginDialog.showModal();
      });

      btnLogout.addEventListener("click", () => {
        isAuthed = false;
        saveAuth(false);
        refreshAuthUI();
        toastMsg("ƒê√£ ƒëƒÉng xu·∫•t.");
      });

      btnLogin.addEventListener("click", (e) => {
        e.preventDefault();
        const u = (loginUser.value || "").trim();
        const p = loginPass.value || "";
        if(u === ADMIN_USER && p === ADMIN_PASS){
          isAuthed = true;
          saveAuth(true);
          refreshAuthUI();
          loginDialog.close();
          toastMsg("ƒêƒÉng nh·∫≠p th√†nh c√¥ng.");
        }else{
          loginMsg.textContent = "Sai username ho·∫∑c password.";
        }
      });

      // Admin: dictionary editor
      btnSave.addEventListener("click", () => {
        requireAuth();
        const enVal = (en.value || "").trim();
        const viVal = (vi.value || "").trim();
        const tagsVal = (tags.value || "").trim();

        if(!enVal || !viVal){
          toastMsg("Vui l√≤ng nh·∫≠p ƒë·ªß: T·ª´ ti·∫øng Anh v√† Gi·∫£i nghƒ©a ti·∫øng Vi·ªát.");
          return;
        }

        const tagArr = parseTags(tagsVal);

        if(editingId){
          const idx = data.findIndex(x => x.id === editingId);
          if(idx >= 0){
            data[idx] = { ...data[idx], en: enVal, vi: viVal, tags: tagArr };
            toastMsg("ƒê√£ c·∫≠p nh·∫≠t.");
          }
        }else{
          data.unshift({ id: crypto.randomUUID(), en: enVal, vi: viVal, tags: tagArr });
          toastMsg("ƒê√£ th√™m m·ªõi.");
        }

        saveData();
        clearEditor();
        rebuildTagFilter();
        render();
        buildAutocomplete(true);
      });

      btnCancelEdit.addEventListener("click", clearEditor);

      // Admin: import/export dictionary
      btnImport.addEventListener("click", async () => {
        requireAuth();
        const f = fileInput.files?.[0];
        if(!f){ toastMsg("H√£y ch·ªçn file .json ho·∫∑c .csv tr∆∞·ªõc."); return; }
        try{
          const text = await f.text();
          let imported = [];
          if(f.name.toLowerCase().endsWith(".json")) imported = parseJson(text);
          else imported = parseCsv(text);

          let updated = 0, added = 0;
          for(const it of imported){
            const key = (it.en || "").trim().toLowerCase();
            if(!key) continue;
            const idx = data.findIndex(x => x.en.trim().toLowerCase() === key);
            const normalized = {
              id: (idx>=0 ? data[idx].id : crypto.randomUUID()),
              en: (it.en||"").trim(),
              vi: (it.vi||"").trim(),
              tags: Array.isArray(it.tags) ? it.tags.map(t=>String(t).trim()).filter(Boolean) : parseTags(String(it.tags||""))
            };
            if(idx>=0){ data[idx] = normalized; updated++; }
            else { data.unshift(normalized); added++; }
          }

          saveData();
          rebuildTagFilter();
          render();
          buildAutocomplete(true);
          toastMsg(`Import xong. Th√™m m·ªõi: ${added}, C·∫≠p nh·∫≠t: ${updated}.`);
          fileInput.value = "";
        }catch(err){
          console.error(err);
          toastMsg("Import l·ªói. Ki·ªÉm tra ƒë·ªãnh d·∫°ng file.");
        }
      });

      btnExport.addEventListener("click", () => {
        requireAuth();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type:"application/json" });
        downloadBlob(blob, "dictionary-data.json");
        toastMsg("ƒê√£ export JSON.");
      });

      btnReset.addEventListener("click", () => {
        requireAuth();
        if(confirm("Reset s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu t·ª´ ƒëi·ªÉn tr√™n tr√¨nh duy·ªát. Ti·∫øp t·ª•c?")){
          data = seedData.map(x => ({ id: crypto.randomUUID(), ...x }));
          saveData();
          rebuildTagFilter();
          render();
          buildAutocomplete(true);
          toastMsg("ƒê√£ reset d·ªØ li·ªáu v·ªÅ m·∫´u.");
        }
      });

      btnDownloadTemplate.addEventListener("click", () => {
        requireAuth();
        const csv = "en,vi,tags\nrun,\"ch·∫°y; v·∫≠n h√†nh\",\"th·ªÉ thao, ƒë·ªông t·ª´ ph·ªï bi·∫øn\"\nappointment,\"cu·ªôc h·∫πn\",\"y t·∫ø, c√¥ng vi·ªác\"\n";
        const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
        downloadBlob(blob, "dictionary-template.csv");
      });

      // Admin: requests export/clear
      btnReqExport.addEventListener("click", () => {
        requireAuth();
        const blob = new Blob([JSON.stringify(reqs, null, 2)], { type:"application/json" });
        downloadBlob(blob, "dictionary-requests.json");
        toastMsg("ƒê√£ export ghi ch√∫ (JSON).");
      });

      btnReqClearAll.addEventListener("click", () => {
        requireAuth();
        if(confirm("X√≥a to√†n b·ªô ghi ch√∫ t·ª´ m·ªõi tr√™n tr√¨nh duy·ªát Admin?")){
          reqs = [];
          saveReqs();
          renderReqs();
          toastMsg("ƒê√£ x√≥a to√†n b·ªô ghi ch√∫.");
        }
      });
    }

    /***********************
     * AUTOCOMPLETE (EN)
     ***********************/
    function buildAutocomplete(forceShow=false){
      const query = (q.value || "").trim().toLowerCase();
      if(!forceShow && !query){ hideAutocomplete(); return; }

      const candidates = data
        .map(it => ({ it, enL: it.en.toLowerCase() }))
        .filter(x => query ? x.enL.includes(query) : true);

      candidates.sort((a,b) => {
        if(!query) return a.it.en.localeCompare(b.it.en, "en");
        const aP = a.enL.startsWith(query) ? 0 : 1;
        const bP = b.enL.startsWith(query) ? 0 : 1;
        if(aP !== bP) return aP - bP;
        if(a.it.en.length !== b.it.en.length) return a.it.en.length - b.it.en.length;
        return a.it.en.localeCompare(b.it.en, "en");
      });

      acItems = candidates.slice(0, 10).map(x => x.it);
      acActiveIndex = acItems.length ? 0 : -1;
      renderAutocomplete();
    }

    function renderAutocomplete(){
      if(!acItems.length){
        ac.innerHTML = `<div class="acEmpty">Kh√¥ng c√≥ g·ª£i √Ω theo ti·∫øng Anh. (B·∫°n v·∫´n c√≥ th·ªÉ t√¨m theo ti·∫øng Vi·ªát/tag trong b·∫£ng)</div>`;
        showAutocomplete();
        return;
      }
      const query = (q.value || "").trim().toLowerCase();
      ac.innerHTML = acItems.map((it, idx) => {
        const active = idx === acActiveIndex ? "active" : "";
        const tagsHtml = (it.tags || []).slice(0,3).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("");
        return `
          <div class="acItem ${active}" role="option" aria-selected="${idx===acActiveIndex}" data-id="${it.id}">
            <div class="acTop"><div class="acEn">${highlight(it.en, query)}</div></div>
            <div class="acVi">${escapeHtml(it.vi)}</div>
            <div class="acTags">${tagsHtml}</div>
          </div>
        `;
      }).join("");

      [...ac.querySelectorAll(".acItem")].forEach((el, idx) => {
        el.addEventListener("mouseenter", () => { acActiveIndex = idx; renderAutocomplete(); });
        el.addEventListener("mousedown", (e) => {
          e.preventDefault();
          const id = el.getAttribute("data-id");
          const it = acItems.find(x => x.id === id);
          if(it) selectAutocomplete(it);
        });
      });

      showAutocomplete();
      ensureActiveVisible();
    }

    function ensureActiveVisible(){
      const activeEl = ac.querySelector(".acItem.active");
      if(!activeEl) return;
      const top = activeEl.offsetTop;
      const bottom = top + activeEl.offsetHeight;
      if(top < ac.scrollTop) ac.scrollTop = top - 6;
      else if(bottom > ac.scrollTop + ac.clientHeight) ac.scrollTop = bottom - ac.clientHeight + 6;
    }

    function selectAutocomplete(it){
      q.value = it.en;
      hideAutocomplete();
      render();
    }

    function showAutocomplete(){ ac.classList.remove("hidden"); }
    function hideAutocomplete(){
      ac.classList.add("hidden");
      acItems = [];
      acActiveIndex = -1;
      ac.innerHTML = "";
    }

    /***********************
     * MAIN RENDER
     ***********************/
    function refreshAuthUI(){
      authState.textContent = isAuthed ? "ƒê√£ ƒëƒÉng nh·∫≠p (Admin)" : "Ch∆∞a ƒëƒÉng nh·∫≠p";
      adminPanel.classList.toggle("hidden", !isAuthed);
      btnLogout.classList.toggle("hidden", !isAuthed);
    }

    function render(){
      const query = (q.value || "").trim().toLowerCase();
      const tag = (tagFilter.value || "").trim().toLowerCase();

      let filtered = data.filter(it => {
        const enTxt = it.en.toLowerCase();
        const viTxt = it.vi.toLowerCase();
        const tagsTxt = (it.tags || []).join(" ").toLowerCase();

        const okQuery = !query || enTxt.includes(query) || viTxt.includes(query) || tagsTxt.includes(query);
        const okTag = !tag || (it.tags || []).some(t => t.toLowerCase() === tag);
        return okQuery && okTag;
      });

      filtered.sort((a,b) => {
        if(!query) return a.en.localeCompare(b.en, "en");
        const aEn = a.en.toLowerCase(), bEn = b.en.toLowerCase();
        const aVi = a.vi.toLowerCase(), bVi = b.vi.toLowerCase();
        const aTags = (a.tags||[]).join(" ").toLowerCase();
        const bTags = (b.tags||[]).join(" ").toLowerCase();

        const score = (s) => {
          if(!query) return 0;
          if(s.startsWith(query)) return 0;
          if(s.includes(query)) return 1;
          return 2;
        };

        const sa = Math.min(score(aEn), score(aVi), score(aTags));
        const sb = Math.min(score(bEn), score(bVi), score(bTags));
        if(sa !== sb) return sa - sb;

        if(a.en.length !== b.en.length) return a.en.length - b.en.length;
        return a.en.localeCompare(b.en, "en");
      });

      countAll.textContent = String(data.length);
      countShown.textContent = String(filtered.length);

      const MAX_ROWS = 200;
      const shown = filtered.slice(0, MAX_ROWS);

      tbody.innerHTML = "";
      for(const it of shown){
        const tr = document.createElement("tr");

        const tdEn = document.createElement("td");
        tdEn.innerHTML = highlight(it.en, query);

        const tdVi = document.createElement("td");
        tdVi.innerHTML = highlight(it.vi, query);

        const tdTags = document.createElement("td");
        tdTags.innerHTML = (it.tags || []).map(t => `<span class="tag">${highlight(escapeHtml(t), query)}</span>`).join("");

        const tdAct = document.createElement("td");
        const actWrap = document.createElement("div");
        actWrap.className = "actions";

        const btnEdit = document.createElement("button");
        btnEdit.textContent = "S·ª≠a";
        btnEdit.disabled = !isAuthed;
        btnEdit.addEventListener("click", () => startEdit(it.id));

        const btnDel = document.createElement("button");
        btnDel.textContent = "X√≥a";
        btnDel.className = "danger";
        btnDel.disabled = !isAuthed;
        btnDel.addEventListener("click", () => delItem(it.id));

        actWrap.appendChild(btnEdit);
        actWrap.appendChild(btnDel);
        tdAct.appendChild(actWrap);

        tr.appendChild(tdEn);
        tr.appendChild(tdVi);
        tr.appendChild(tdTags);
        tr.appendChild(tdAct);

        tbody.appendChild(tr);
      }

      if(filtered.length > MAX_ROWS){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.className = "muted";
        td.textContent = `ƒêang hi·ªÉn th·ªã ${MAX_ROWS}/${filtered.length} k·∫øt qu·∫£. H√£y nh·∫≠p th√™m k√Ω t·ª± ƒë·ªÉ l·ªçc h·∫πp h∆°n.`;
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    /***********************
     * REQUESTS (Admin view)
     ***********************/
    function renderReqs(){
      if(!reqTbody) return;
      reqTbody.innerHTML = "";

      if(!reqs.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.className = "muted";
        td.textContent = "Ch∆∞a c√≥ ghi ch√∫ n√†o trong tr√¨nh duy·ªát n√†y.";
        tr.appendChild(td);
        reqTbody.appendChild(tr);
        return;
      }

      for(const r of reqs){
        const tr = document.createElement("tr");

        const tdEn = document.createElement("td");
        tdEn.textContent = r.en;

        const tdTags = document.createElement("td");
        tdTags.innerHTML = (r.tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("");

        const tdNote = document.createElement("td");
        tdNote.textContent = r.note;

        const tdAct = document.createElement("td");
        const wrap = document.createElement("div");
        wrap.className = "actions";

        const btnUse = document.createElement("button");
        btnUse.textContent = "ƒê∆∞a v√†o form";
        btnUse.disabled = !isAuthed;
        btnUse.addEventListener("click", () => {
          requireAuth();
          en.value = r.en;
          tags.value = (r.tags || []).join(", ");
          vi.value = "";
          editingId = null;
          editState.textContent = "T·∫°o m·ªõi t·ª´ ghi ch√∫: " + r.en;
          toastMsg("ƒê√£ ƒë∆∞a sang form. H√£y nh·∫≠p nghƒ©a ti·∫øng Vi·ªát r·ªìi b·∫•m L∆∞u.");
          window.scrollTo({ top: 0, behavior:"smooth" });
        });

        const btnDel = document.createElement("button");
        btnDel.textContent = "X√≥a ghi ch√∫";
        btnDel.className = "danger";
        btnDel.disabled = !isAuthed;
        btnDel.addEventListener("click", () => {
          requireAuth();
          if(confirm(`X√≥a ghi ch√∫: "${r.en}" ?`)){
            reqs = reqs.filter(x => x.id !== r.id);
            saveReqs();
            renderReqs();
            toastMsg("ƒê√£ x√≥a ghi ch√∫.");
          }
        });

        wrap.appendChild(btnUse);
        wrap.appendChild(btnDel);
        tdAct.appendChild(wrap);

        tr.appendChild(tdEn);
        tr.appendChild(tdTags);
        tr.appendChild(tdNote);
        tr.appendChild(tdAct);

        reqTbody.appendChild(tr);
      }
    }

    /***********************
     * DICTIONARY EDIT
     ***********************/
    function startEdit(id){
      requireAuth();
      const it = data.find(x => x.id === id);
      if(!it) return;
      editingId = id;
      en.value = it.en;
      vi.value = it.vi;
      tags.value = (it.tags || []).join(", ");
      editState.textContent = "ƒêang s·ª≠a: " + it.en;
      toastMsg("ƒêang ·ªü ch·∫ø ƒë·ªô s·ª≠a. B·∫•m L∆∞u ƒë·ªÉ c·∫≠p nh·∫≠t.");
      hideAutocomplete();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function clearEditor(){
      editingId = null;
      en.value = "";
      vi.value = "";
      tags.value = "";
      editState.textContent = "ƒêang th√™m m·ªõi";
    }

    function delItem(id){
      requireAuth();
      const it = data.find(x => x.id === id);
      if(!it) return;
      if(confirm(`X√≥a m·ª•c t·ª´: "${it.en}" ?`)){
        data = data.filter(x => x.id !== id);
        saveData();
        rebuildTagFilter();
        render();
        buildAutocomplete(true);
        toastMsg("ƒê√£ x√≥a.");
        if(editingId === id) clearEditor();
      }
    }

    function rebuildTagFilter(){
      const current = tagFilter.value || "";
      const allTags = new Map();
      for(const it of data){
        for(const t of (it.tags || [])){
          const k = String(t).trim();
          if(!k) continue;
          allTags.set(k.toLowerCase(), k);
        }
      }
      const sorted = [...allTags.entries()].sort((a,b)=> a[1].localeCompare(b[1], "vi"));
      tagFilter.innerHTML = `<option value="">T·∫•t c·∫£ tag</option>` + sorted.map(([k,label]) => `<option value="${escapeHtml(k)}">${escapeHtml(label)}</option>`).join("");
      tagFilter.value = current.toLowerCase() || "";
    }

    /***********************
     * PARSERS + HELPERS
     ***********************/
    function parseTags(s){
      if(!s) return [];
      return s.split(",").map(x => x.trim()).filter(Boolean);
    }

    function parseJson(text){
      const raw = JSON.parse(text);
      if(!Array.isArray(raw)) throw new Error("JSON must be an array");
      return raw.map(x => ({
        en: x.en ?? x.english ?? "",
        vi: x.vi ?? x.vietnamese ?? "",
        tags: x.tags ?? x.usage ?? ""
      }));
    }

    function parseCsv(text){
      const rows = csvToRows(text);
      if(rows.length === 0) return [];
      const header = rows[0].map(h => h.trim().toLowerCase());
      const idxEn = header.indexOf("en");
      const idxVi = header.indexOf("vi");
      const idxTags = header.indexOf("tags");
      if(idxEn < 0 || idxVi < 0) throw new Error("CSV header must include en,vi,tags");
      const out = [];
      for(let i=1;i<rows.length;i++){
        const r = rows[i];
        if(r.every(c => !String(c||"").trim())) continue;
        out.push({ en: r[idxEn] ?? "", vi: r[idxVi] ?? "", tags: (idxTags>=0 ? (r[idxTags] ?? "") : "") });
      }
      return out;
    }

    function csvToRows(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];

        if(ch === '"' ){
          if(inQuotes && next === '"'){ cur += '"'; i++; }
          else { inQuotes = !inQuotes; }
          continue;
        }

        if(!inQuotes && ch === ","){ row.push(cur); cur = ""; continue; }
        if(!inQuotes && ch === "\n"){ row.push(cur); rows.push(row); row = []; cur = ""; continue; }
        if(ch === "\r") continue;
        cur += ch;
      }
      row.push(cur);
      rows.push(row);
      return rows.filter(r => !(r.length===1 && !String(r[0]||"").trim()));
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function highlight(text, query){
      const safe = escapeHtml(text ?? "");
      if(!query) return safe;
      const qx = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const re = new RegExp(qx, "ig");
      return safe.replace(re, (m) => `<mark>${m}</mark>`);
    }

    function toastMsg(msg){
      if(!toast) return;
      toast.textContent = msg;
      setTimeout(()=>{ toast.textContent = ""; }, 4000);
    }

    function requireAuth(){
      if(!isAuthed){
        toastMsg("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ thao t√°c n√†y.");
        throw new Error("Not authed");
      }
    }

    /***********************
     * STORAGE
     ***********************/
    function loadData(){
      try{
        const s = localStorage.getItem(LS_KEY_DATA);
        if(!s){
          const seeded = seedData.map(x => ({ id: crypto.randomUUID(), ...x }));
          localStorage.setItem(LS_KEY_DATA, JSON.stringify(seeded));
          return seeded;
        }
        const parsed = JSON.parse(s);
        if(!Array.isArray(parsed)) throw new Error("bad");
        return parsed.map(x => ({
          id: x.id || crypto.randomUUID(),
          en: String(x.en || "").trim(),
          vi: String(x.vi || "").trim(),
          tags: Array.isArray(x.tags) ? x.tags.map(t=>String(t).trim()).filter(Boolean) : parseTags(String(x.tags||""))
        }));
      }catch(_){
        const seeded = seedData.map(x => ({ id: crypto.randomUUID(), ...x }));
        localStorage.setItem(LS_KEY_DATA, JSON.stringify(seeded));
        return seeded;
      }
    }

    function saveData(){ localStorage.setItem(LS_KEY_DATA, JSON.stringify(data)); }

    function loadReqs(){
      try{
        const s = localStorage.getItem(LS_KEY_REQS);
        if(!s) return [];
        const parsed = JSON.parse(s);
        if(!Array.isArray(parsed)) return [];
        return parsed.map(x => ({
          id: x.id || crypto.randomUUID(),
          en: String(x.en || "").trim(),
          tags: Array.isArray(x.tags) ? x.tags.map(t=>String(t).trim()).filter(Boolean) : parseTags(String(x.tags||"")),
          note: String(x.note || "").trim(),
          createdAt: x.createdAt || new Date().toISOString()
        }));
      }catch(_){ return []; }
    }
    function saveReqs(){ localStorage.setItem(LS_KEY_REQS, JSON.stringify(reqs)); }

    function loadAuth(){ return localStorage.getItem(LS_KEY_AUTH) === "1"; }
    function saveAuth(v){ localStorage.setItem(LS_KEY_AUTH, v ? "1" : "0"); }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
